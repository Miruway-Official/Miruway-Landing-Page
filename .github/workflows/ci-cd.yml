# ==========================================
# Miru Way Landing Page - CI/CD Pipeline
# GitHub Actions + Docker + Self-hosted Runner
# ==========================================

name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  DOCKER_IMAGE_NAME: miru-way-landing-page
  CONTAINER_NAME: miru-way-landing-page-app
  APP_PORT: 6095

jobs:
  # ==========================================
  # Job 1: Test & Lint
  # ==========================================
  test:
    name: ğŸ§ª Test & Lint
    runs-on: self-hosted

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          clean: false

      - name: ğŸ“¦ Install dependencies
        run: bun install --no-save --frozen-lockfile

      - name: ğŸ” Run ESLint
        run: bun run lint
        continue-on-error: false

      - name: ğŸ¨ Check TypeScript
        run: bun run type-check
        continue-on-error: false

      - name: ğŸ§ª Run Tests
        run: bun run test
        continue-on-error: true

      - name: ğŸ—‘ï¸ Cleanup files
        if: always()
        run: |
          rm -rf node_modules .next
          git clean -fdx
  # ==========================================
  # Job 2: Build Docker Image
  # ==========================================
  build:
    name: ğŸ—ï¸ Build Docker Image
    runs-on: ubuntu-22.04
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          tags: ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ§ª Test Docker image
        run: |
          docker run -d --name test-container -p 6095:6095 ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          sleep 10
          curl --fail http://localhost:6095 || exit 1
          docker stop test-container
          docker rm test-container

      - name: ğŸ’¾ Save Docker image
        run: |
          docker save ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} | gzip > image.tar.gz

      - name: ğŸ“¤ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: image.tar.gz
          retention-days: 1

      - name: ğŸ—‘ï¸ Cleanup files
        if: always()
        run: |
          rm -rf node_modules .next
          git clean -fdx

  # ==========================================
  # Job 3: Deploy (Self-hosted Runner)
  # ==========================================
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: self-hosted
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: ğŸ“¦ Load Docker image
        run: |
          gunzip -c image.tar.gz | docker load

      - name: ğŸ›‘ Stop existing container
        run: |
          docker stop ${{ env.CONTAINER_NAME }} || true
          docker rm ${{ env.CONTAINER_NAME }} || true

      - name: ğŸš€ Deploy new container
        run: |
          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            --restart unless-stopped \
            -p ${{ env.APP_PORT }}:6095 \
            -e NODE_ENV=production \
            ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}

      - name: âœ… Health check
        run: |
          sleep 15
          curl --fail http://localhost:${{ env.APP_PORT }} || exit 1

      - name: ğŸ§¹ Cleanup old images
        run: |
          docker image prune -af --filter "until=6h"

      - name: ğŸ—‘ï¸ Cleanup artifact file
        run: |
          rm -f image.tar.gz

      - name: ğŸ—‘ï¸ Delete artifact from GitHub
        uses: geekyeggo/delete-artifact@v5
        with:
          name: docker-image
          failOnError: false

      - name: ğŸ—‘ï¸ Cleanup files
        if: always()
        run: |
          cd ..
          rm -rf Miruway-Landing-Page
          git clean -fdx
