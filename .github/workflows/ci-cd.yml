# ==========================================
# Miru Way Landing Page - CI/CD Pipeline
# GitHub Actions + Docker + Self-hosted Runner
# ==========================================

name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  DOCKER_IMAGE_NAME: miru-way-landing-page
  CONTAINER_NAME: miru-way-landing-page-app
  APP_PORT: 6095

jobs:
  # ==========================================
  # Job 1: Test & Lint
  # ==========================================
  test:
    name: ðŸ§ª Test & Lint
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸž Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: ðŸ“¦ Install dependencies
        run: bun install --no-save --frozen-lockfile

      - name: ðŸ” Run ESLint
        run: bun run lint
        continue-on-error: false

      - name: ðŸŽ¨ Check TypeScript
        run: bun run type-check
        continue-on-error: false

      - name: ðŸ§ª Run Tests
        run: bun run test
        continue-on-error: true

  # ==========================================
  # Job 2: Build Docker Image
  # ==========================================
  build:
    name: ðŸ—ï¸ Build Docker Image
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ—ï¸ Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          tags: ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ðŸ§ª Test Docker image
        run: |
          docker run -d --name test-container -p 6095:6095 ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          sleep 10
          curl --fail http://localhost:6095 || exit 1
          docker stop test-container
          docker rm test-container

      - name: ðŸ’¾ Save Docker image
        run: |
          docker save ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} | gzip > image.tar.gz

      - name: ðŸ“¤ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: image.tar.gz
          retention-days: 1

  # ==========================================
  # Job 3: Deploy (Self-hosted Runner)
  # ==========================================
  deploy:
    name: ðŸš€ Deploy to Production
    runs-on: self-hosted
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ðŸ“¥ Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: ðŸ“¦ Load Docker image
        run: |
          gunzip -c image.tar.gz | docker load

      - name: ðŸ›‘ Stop existing container
        run: |
          docker stop ${{ env.CONTAINER_NAME }} || true
          docker rm ${{ env.CONTAINER_NAME }} || true

      - name: ðŸš€ Deploy new container
        run: |
          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            --restart unless-stopped \
            -p ${{ env.APP_PORT }}:6095 \
            -e NODE_ENV=production \
            ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}

      - name: âœ… Health check
        run: |
          sleep 15
          curl --fail http://localhost:${{ env.APP_PORT }} || exit 1

      - name: ðŸ§¹ Cleanup old images
        run: |
          docker image prune -af --filter "until=24h"
